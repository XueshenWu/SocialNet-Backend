
  <!DOCTYPE html>
  <html>
    <head>
      <title>db.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="..\..\..\..\assets\source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="..\..\..\..\assets\source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="..\..\..\..\index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src\xueshen\db\db.service.ts</td><td class="">100.00%</td><td class="">80%</td><td class="">0</td><td class="">0</td><td class="">0</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">// import { Injectable, Logger } from &#x27;@nestjs/common&#x27;;
// import { PrismaClient as PgClient, Prisma as PgPrisma, User } from &#x27;@prisma/pg&#x27;
// import { PrismaClient as MongoClient, Prisma as MongoPrisma, Post } from &#x27;@prisma/mongo&#x27;;
// import { PTX } from &#x27;../types/prisma_tx&#x27;;
// import * as assert from &#x27;assert&#x27;;
// import createUserDto from &#x27;../dto/createUserDto&#x27;;
// import { DbPostService } from &#x27;./post/db_post.service&#x27;;
// import { DbUserService } from &#x27;./user/db_user.service&#x27;;
// import UpdateProfileDto from &#x27;../dto/updateProfileDto&#x27;;
// import CreatePostDto from &#x27;../dto/createPostDto&#x27;;
// import CreateReplyDto from &#x27;../dto/createReplyDto&#x27;;
// import { exec } from &#x27;child_process&#x27;;
// import CreateRepostDto from &#x27;../dto/createRepostDto&#x27;;




// @Injectable()
// export class DbService {
//     private readonly pgClient = new PgClient();
//     private readonly mongoClient = new MongoClient();
//     private readonly logger = new Logger();


//     constructor(private readonly dbPostService: DbPostService, private readonly dbUserService: DbUserService) {

//     }

//     async query_origin_posts_by_user_id(id: string): Promise&lt;Post[]&gt; {
//         return this.dbPostService.query_origin_posts_by_user_id(id);
//     }

//     async query_reposted_posts_by_user_id(id: string): Promise&lt;Post[]&gt; {
//         return this.dbPostService.query_reposted_posts_by_user_id(id);
//     }

//     async query_liked_posts_by_user_id(id: string): Promise&lt;String[]&gt; {
//        return this.dbPostService.query_liked_posts_by_user_id(id);
//     }



//     async isFollowing(id_from: string, id_to: string): Promise&lt;boolean&gt; {
//         return this.dbUserService.isFollowing(id_from, id_to);
//     }

//     async repost(createRepostDto:CreateRepostDto):Promise&lt;string|undefined&gt;{
//         return await this.dbPostService.repost(createRepostDto);
//     }
//     async query_user_by_email(email: string): Promise&lt;User | undefined&gt; {
//         return this.pgClient.user.findUnique({
//             where: {
//                 email: email
//             }
//         })

//     }   

//     async query_replies_by_post_id(id:string){
//         return this.dbPostService.getRepliesByPostId(id);
//     }

//     async query_posts_by_user_id(id: string): Promise&lt;Post[]&gt; {
//         return this.dbPostService.findPostsByUserId(id);
//     }

//     async query_user_by_id(id: string): Promise&lt;User | undefined&gt; {
//         return this.pgClient.user.findUnique({
//             where: {
//                 id: id
//             }
//         })
//     }


//     async query_post_by_id(id: string): Promise&lt;Post | undefined&gt; {
      
//         return this.dbPostService.findPostByPostId(id);
//     }

//     // Tested
//     async sendNotification(userId: string, notification: MongoPrisma.NotificationCreateInput): Promise&lt;string | undefined&gt; {
//         try {
//             await this.mongoClient.notificationCenter.update({
//                 where: {
//                     userId: userId
//                 },
//                 data: {
//                     notifications: {
//                         push: notification
//                     }
//                 }
//             })
//         } catch (e) {
//             this.logger.verbose(e);
//             return undefined;
//         }
//     }

//     // DO NOT USE THIS METHOD EXCEPT FOR TESTING
//     getPgClient_DANGEROUS(): PgClient {
//         assert(process.env.ALLOW_DANGEROUS === &quot;TRUE&quot;)
//         return this.pgClient;
//     }

//     // DO NOT USE THIS METHOD EXCEPT FOR TESTING
//     getMongoClient_DANGEROUS(): MongoClient {

//         assert(process.env.ALLOW_DANGEROUS === &quot;TRUE&quot;)
//         return this.mongoClient;
//     }


//     // NEVER USE THIS METHOD IN PRODUCTION
//     async resetDatabse_DANGEROUS(log = false) {

//         assert(process.env.ALLOW_DANGEROUS === &quot;TRUE&quot;)
//         // await new Promise((resolve)=&gt;exec(` npx prisma migrate reset --force --schema=&quot;prisma/schema.mongo.prisma&quot;&amp;&amp; npx prisma migrate reset --force --schema=&quot;prisma/schema.mongo.prisma&quot;`, (err, stdout, stderr) =&gt; {resolve(undefined)}))
//         return;
        
//         const pgClient = this.getPgClient_DANGEROUS()



//         await pgClient.$transaction(async (tx) =&gt; {
//             await tx.follow.deleteMany()
//             await tx.friend.deleteMany()
//             await tx.profile.deleteMany()
//             await tx.user.deleteMany()
//         })

//         const mongoClient = this.getMongoClient_DANGEROUS()



//         await mongoClient.$transaction(async (tx) =&gt; {
//             await tx.likeTable.deleteMany()
//             await tx.likeTable.deleteMany()



//             await tx.post.deleteMany()
//             await tx.post.deleteMany()

//             await tx.notificationCenter.deleteMany()
//             await tx.notificationCenter.deleteMany()

//             await tx.user.deleteMany()
//             await tx.user.deleteMany()
//         })



//     }

//     // Tested
//     // return true if success, false if failed(e.g. already friend)
//     async addFriend(id_from: string, id_to: string): Promise&lt;boolean&gt; {
//         try {
//             await this.pgClient.$transaction(async (tx) =&gt; {
//                 await tx.friend.create({
//                     data: {
//                         id_from: id_from,
//                         id_to: id_to
//                     }
//                 })
//                 await tx.friend.create({
//                     data: {
//                         id_from: id_to,
//                         id_to: id_from
//                     }
//                 })
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }

//     }

//     // Tested
//     // return true if success, false if failed(e.g. not friend yet)
//     async deleteFriend(id_from: string, id_to: string): Promise&lt;boolean&gt; {

//         const res = await this.pgClient.$transaction(async (tx) =&gt; {
//             try {
//                 await tx.friend.delete({
//                     where: {
//                         id_from_id_to: {
//                             id_from: id_from,
//                             id_to: id_to
//                         }
//                     }
//                 })
//                 await tx.friend.delete({
//                     where: {
//                         id_from_id_to: {
//                             id_from: id_to,
//                             id_to: id_from
//                         }
//                     }
//                 })
//                 return true


//             }

//             catch (e) {

//                 this.logger.warn(e);
//                 return false;
//             }
//         })
//         return res;

//     }

//     // Tested
//     // return true if success, false if failed(e.g. already followed)
//     async followUser(id_from: string, id_to: string): Promise&lt;boolean&gt; {
//         try {
//             await this.pgClient.follow.create({
//                 data: {
//                     id_from: id_from,
//                     id_to: id_to
//                 }
//             })


//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     // Tested
//     // return true if success, false if failed(e.g. already unfollowed)
//     // async unfollowUser(id_from: string, id_to: string): Promise&lt;boolean&gt; {
//     //     try {
//     //         await this.pgClient.follow.delete({
//     //             where: {
//     //                 id_from_id_to: {
//     //                     id_from: id_from,
//     //                     id_to: id_to
//     //                 }
//     //             }
//     //         })
//     //         return true;
//     //     } catch (e) {
//     //         this.logger.verbose(e);
//     //         return false;
//     //     }
//     // }

//     // // Tested
//     // // return userId if success, undefined if failed(e.g. violation of unique constraint)
//     // async createUser(createUserInput: createUserDto): Promise&lt;string | undefined&gt; {
//     //     const res = await this.pgClient.$transaction(async (tx_pg) =&gt; {




//     //         try {
//     //             const user = await tx_pg.user.create({
//     //                 data: {
//     //                     email: createUserInput.email,
//     //                     password: createUserInput.password,
//     //                     role: createUserInput.role,
//     //                     username: createUserInput.email
//     //                 }

//     //             })
//     //             await tx_pg.profile.create({
//     //                 data: {
//     //                     fullname: createUserInput.name ?? user.id,
//     //                     user: {
//     //                         connect: {
//     //                             id: user.id
//     //                         }
//     //                     },
                        
//     //                     gender: createUserInput.gender ?? &quot;Prefer not to say&quot;,
                        

//     //                 }

//     //             })

//     //             await this.mongoClient.user.create({
//     //                 data: {
//     //                     id: user.id,
//     //                     notificationCenter: {
//     //                         create: {
//     //                             notifications: []
//     //                         }
//     //                     },

//     //                 }
//     //             })
               
//     //             return user.id;

//     //         } catch (e) {
//     //             console.log(e)
//     //             this.logger.warn(e);
//     //             return undefined
//     //         }

//     //     })
//     //     return res;
//     // }


//     //Tested
//     // return postId if success, undefined if failed
//     async addPost(post: CreatePostDto): Promise&lt;string | undefined&gt; {
//         // try {
//         //     const postRecord = await this.mongoClient.post.create({
//         //         data: post
//         //     })
//         //     return postRecord.id;
//         // } catch (e) {
//         //     this.logger.warn(e);
//         //     return undefined
//         // }
//         return this.dbPostService.addPost(post);
//     }


//     //Tested
//     // return true if success, false if failed
//     async updatePostStatus(postId: string, status: &quot;DRAFT&quot; | &quot;UNDER_REVIEW&quot; | &quot;PUBLISHED&quot; | &quot;HIDDEN&quot;): Promise&lt;boolean&gt; {
//         // try {
//         //     await this.mongoClient.post.update({
//         //         where: {
//         //             id: postId
//         //         },
//         //         data: {
//         //             status: status
//         //         }
//         //     })
//         //     return true;
//         // } catch (e) {
//         //     this.logger.verbose(e);
//         //     return false;
//         // }
//         return this.dbPostService.updatePostStatus(postId, status);
//     }



//     // Tested
//     // return like-Table Id if success, undefined if failed
//     async likePost(userId: string, postId: string): Promise&lt;string | undefined&gt; {
//         // try {
//         //     const likeRecord = await this.mongoClient.likeTable.create({
//         //         data: {
//         //             userId: userId,
//         //             postId: postId
//         //         }
//         //     })


//         //     return likeRecord.id;
//         // } catch (e) {
//         //     this.logger.verbose(e);
//         //     return undefined;
//         // }
//         return this.dbPostService.likePost(userId, postId);
//     }


//     // Tested
//     // return true if success, false if failed
//     async unlikePost(userId: string, postId: string): Promise&lt;boolean&gt; {
//         // try {
//         //     await this.mongoClient.likeTable.delete({
//         //         where: {
//         //             postId_userId: {
//         //                 postId: postId,
//         //                 userId: userId
//         //             }
//         //         }
//         //     })
//         //     return true;
//         // } catch (e) {
//         //     this.logger.verbose(e);
//         //     return false;
//         // }
//         return this.dbPostService.unlikePost(userId, postId);
//     }

//     // Tested
//     // return replyId if success, undefined if failed
//     async addReply(reply: CreateReplyDto): Promise&lt;string | undefined&gt; {
//         // try {
//         //     const replyRecord = await this.mongoClient.reply.create({
//         //         data: reply
//         //     })
//         //     return replyRecord.id;
//         // } catch (e) {
//         //     this.logger.verbose(e);
//         //     return undefined;
//         // }
//         return this.dbPostService.addReply(reply);
//     }

//     // Tested
//     async hidePost(postId: string): Promise&lt;boolean&gt; {
//         // try {
//         //     await this.mongoClient.reply.delete({
//         //         where: {
//         //             id: replyId
//         //         }
//         //     })
//         //     return true;
//         // } catch (e) {
//         //     this.logger.verbose(e);
//         //     return false;
//         // }
//         return this.dbPostService.hidePost(postId);
//     }


//     // return userId if success, undefined if failed
//     async updateProfile(profile: UpdateProfileDto): Promise&lt;boolean&gt; {
//         // try {
//         //     const profileRecord = await this.pgClient.profile.create({
//         //         data: profile
//         //     })
//         //     return profileRecord.userId;
//         // } catch (e) {
//         //     this.logger.verbose(e);
//         //     return undefined;
//         // }
//         return this.dbUserService.updateProfile(profile);
//     }

//     private async aux_hide_all_posts(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.post.updateMany({
//                 data: {
//                     status: &quot;HIDDEN&quot;
//                 },
//                 where: {
//                     authorId: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }

//     }



//     private async aux_dump_follow_relation(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.follow.deleteMany({
//                 where: {
//                     OR: [
//                         {
//                             id_from: id
//                         },
//                         {
//                             id_to: id
//                         }
//                     ]
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_dump_friend_relation(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.friend.deleteMany({
//                 where: {
//                     OR: [
//                         {
//                             id_from: id
//                         },
//                         {
//                             id_to: id
//                         }
//                     ]
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_dump_profile(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.profile.delete({
//                 where: {
//                     userId: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_dump_post(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.post.deleteMany({
//                 where: {
//                     authorId: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }


//     private async aux_dump_like(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.likeTable.deleteMany({
//                 where: {
//                     userId: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }



//     private async aux_dump_ncenter(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.notificationCenter.delete({
//                 where: {
//                     userId: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_dump_user_pg(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.user.delete({
//                 where: {
//                     id: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_dump_user_mongo(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.user.delete({
//                 where: {
//                     id: id
//                 }
//             })
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }



//     // Eradicate a user from the database, including all related data
//     async deleteUser_notsafe_cascade(email: string): Promise&lt;boolean&gt; {

//         const res = await this.pgClient.$transaction(async (tx_pg: PTX&lt;&quot;pg&quot;&gt;) =&gt; {
//             try {

//                 const user = await tx_pg.user.findUnique({
//                     where: {
//                         email: email
//                     }
//                 })
//                 if (!user) {
//                     return false;
//                 } else {
//                     const id = user.id;
//                     await this.aux_dump_follow_relation(tx_pg, id);
//                     await this.aux_dump_friend_relation(tx_pg, id);
//                     await this.aux_dump_profile(tx_pg, id);
//                     await this.mongoClient.$transaction(async (tx_mongo: PTX&lt;&quot;mongo&quot;&gt;) =&gt; {
//                         await this.aux_dump_post(tx_mongo, id);
//                         await this.aux_dump_like(tx_mongo, id);

//                         await this.aux_dump_ncenter(tx_mongo, id);
//                         await this.aux_dump_user_mongo(tx_mongo, id);
//                     });
//                     await this.aux_dump_user_pg(tx_pg, id);

//                     return true;
//                 }

//             } catch (e) {
//                 this.logger.verbose(e);

//                 return true;
//             }
//         })
//         return res;
//     }



//     private async aux_nullify_follow_relation(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         const void_uid = process.env.VOID_USER_ID;
//         try {
//             await tx.follow.updateMany({
//                 data: {
//                     id_from: void_uid
//                 },
//                 where: {
//                     id_from: id
//                 }
//             }
//             );
//             await tx.follow.updateMany({
//                 data: {
//                     id_to: void_uid
//                 },
//                 where: {
//                     id_to: id
//                 }
//             }
//             );
//             return true;


//         }
//         catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_nullify_friend_relation(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         const void_uid = process.env.VOID_USER_ID;
//         try {
//             await tx.friend.updateMany({
//                 data: {
//                     id_from: void_uid
//                 },
//                 where: {
//                     id_from: id
//                 }
//             }
//             );
//             await tx.friend.updateMany({
//                 data: {
//                     id_to: void_uid
//                 },
//                 where: {
//                     id_to: id
//                 }
//             }
//             );
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_nullify_profile(tx: PTX&lt;&quot;pg&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.profile.update({
//                 data: {
//                     userId: process.env.VOID_USER_ID
//                 },
//                 where: {
//                     userId: id
//                 }
//             });
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_nullify_post(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.post.updateMany({
//                 data: {
//                     authorId: process.env.VOID_USER_ID
//                 },
//                 where: {
//                     authorId: id
//                 }
//             });
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }

//     private async aux_nullify_like(tx: PTX&lt;&quot;mongo&quot;&gt;, id: string): Promise&lt;boolean&gt; {
//         try {
//             await tx.likeTable.updateMany({
//                 data: {
//                     userId: process.env.VOID_USER_ID
//                 },
//                 where: {
//                     userId: id
//                 }
//             });
//             return true;
//         } catch (e) {
//             this.logger.verbose(e);
//             return false;
//         }
//     }





//     // delete the user record and redirect all related records to void user
//     async deleteUser_notsafe_nullify(email: string): Promise&lt;boolean&gt; {
//         const res = await this.pgClient.$transaction(async (tx_pg: PTX&lt;&quot;pg&quot;&gt;) =&gt; {
//             try {

//                 const user = await tx_pg.user.findUnique({
//                     where: {
//                         email: email
//                     }
//                 })
//                 if (!user) {
//                     return false;
//                 } else {
//                     const id = user.id;
//                     await this.aux_nullify_follow_relation(tx_pg, id);
//                     await this.aux_nullify_friend_relation(tx_pg, id);
//                     await this.aux_nullify_profile(tx_pg, id);
//                     await this.aux_dump_user_pg(tx_pg, id);

//                     await this.mongoClient.$transaction(async (tx_mongo: PTX&lt;&quot;mongo&quot;&gt;) =&gt; {
//                         await this.aux_hide_all_posts(tx_mongo, id);
//                         await this.aux_nullify_post(tx_mongo, id);
//                         await this.aux_nullify_like(tx_mongo, id);
//                         await this.aux_dump_user_mongo(tx_mongo, id);
//                     });
//                     return true;
//                 }

//             }
//             catch (e) {
//                 this.logger.verbose(e);
//                 return false;
//             }

//         })

//         return res;
//     }


//     // restrict the user from login and hide all posts
//     async deleteUser_setdisabled(email: string): Promise&lt;boolean&gt; {
//         const res = await this.pgClient.$transaction(async (tx_pg) =&gt; {
//             const user = await tx_pg.user.findUnique({
//                 where: {
//                     email: email
//                 }
//             })

//             if (!user) {
//                 return false;
//             } else {
//                 await tx_pg.user.update({
//                     data: {
//                         role: &quot;DISABLED&quot;
//                     },
//                     where: {
//                         id: user.id
//                     }
//                 })
//                 await this.mongoClient.$transaction(async (tx_mongo: PTX&lt;&quot;mongo&quot;&gt;) =&gt; { this.aux_hide_all_posts(tx_mongo, user.id) });
//                 return true;
//             }

//         })
//         return res;
//     }

// }
</textarea><pre id="annotations" style="display:none">[]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 04 Apr 2024 16:26:48 GMT</p>
    </body>
  </html>
  